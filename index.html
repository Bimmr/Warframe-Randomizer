<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />

        <meta name="description" content="Generate random Warframe loadouts for your next mission" />
        <meta property="og:description" content="Generate random Warframe loadouts for your next mission" />
        <meta property="og:type" content="website" />

        <title>Warframe Loadout Randomizer</title>
        <meta property="og:title" content="Warframe Loadout Randomizer" />
        <link rel="icon" type="image/png" href="favicon.png" />

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="styles.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Warframe Loadout Randomizer</h1>
                <div class="settings-icon">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
            <dialog id="settings-modal" class="settings-dialog">
                <div class="settings-header">
                    <h2>Settings</h2>
                    <div class="modal-buttons">
                        <button id="settings-import" class="modal-button" title="Import from Inventory file.">
                            <i class="fas fa-file-import"></i>
                        </button>

                        <button
                            popovertarget="settings-help-tooltip"
                            class="help-settings modal-button"
                            id="settings-help"
                            title="Help with Settings"
                        >
                            <i class="fas fa-question"></i>
                        </button>
                        <button class="close-settings modal-button" title="Close Settings" autofocus>
                            <i class="fas fa-times"></i>
                        </button>

                        <input type="file" id="settings-import-input" accept=".dat" />
                        <div popover id="settings-help-tooltip" anchor="settings-help" class="tooltip">
                            <h2>Importing lastData.dat Inventory</h2>
                            <p>You can import your inventory from the AlecaFrame app using the <strong>import button</strong> and selecting your lastData.dat.</p>
                            <p>- You can find this in the <strong>%localappdata%/AlecaFrame</strong> folder.</p>
                            <br><br>
                            <h2>Toggle if the item can be selected in the randomizer</h2>
                            <p>- <strong>Click</strong> on the item to toggle its state</p>
                            <p>- Holding <strong>CTRL + Click</strong> will adjust all the items to the new state</p>
                            <p>
                                - Holding <strong>SHIFT + Click</strong> will adjust all between the previously changed
                                item and the one you clicked.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="settings-content">
                    <div class="warframe-settings">
                        <div class="form-item settings-search">
                            <input
                                type="search"
                                id="warframe-search"
                                title="Search for warframes in the list"
                                required
                            />
                            <label for="warframe-search">Search Warframes</label>
                        </div>
                        <div class="tools">
                            <p class="description">x/y(z)</p>
                            <button class="description toggle-all">Toggle All</button>
                        </div>
                        <ul class="settings-list">
                            <!-- Warframe list will be populated by JavaScript -->
                        </ul>
                    </div>
                    <div class="primary-settings">
                        <div class="form-item settings-search">
                            <input
                                type="search"
                                id="primary-search"
                                title="Search for primary weapons in the list"
                                required
                            />
                            <label for="primary-search">Search Primary Weapons</label>
                        </div>
                        <div class="tools">
                            <p class="description">x/y(z)</p>
                            <button class="description toggle-all">Toggle All</button>
                        </div>
                        <ul class="settings-list">
                            <!-- Primary weapon list will be populated by JavaScript -->
                        </ul>
                    </div>
                    <div class="secondary-settings">
                        <div class="form-item settings-search">
                            <input
                                type="search"
                                id="secondary-search"
                                title="Search for secondary weapons in the list"
                                required
                            />
                            <label for="secondary-search">Search Secondary Weapons</label>
                        </div>
                        <div class="tools">
                            <p class="description">x/y(z)</p>
                            <button class="description toggle-all">Toggle All</button>
                        </div>
                        <ul class="settings-list">
                            <!-- Secondary weapon list will be populated by JavaScript -->
                        </ul>
                    </div>
                    <div class="melee-settings">
                        <div class="form-item settings-search">
                            <input
                                type="search"
                                id="melee-search"
                                title="Search for melee weapons in the list"
                                required
                            />
                            <label for="melee-search">Search Melee Weapons</label>
                        </div>
                        <div class="tools">
                            <p class="description">x/y(z)</p>
                            <button class="description toggle-all">Toggle All</button>
                        </div>
                        <ul class="settings-list">
                            <!-- Melee weapon list will be populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </dialog>
            <div class="warframe skeleton">
                <img class="image" alt="" />
                <div class="info">
                    <div class="details card">
                        <h2 class="name"></h2>
                        <p class="description"></p>
                    </div>
                    <div class="abilities">
                        <div class="ability card">
                            <img class="image" alt="" />
                            <h2 class="name"></h2>
                            <p class="description"></p>
                        </div>
                        <div class="ability card">
                            <img class="image" alt="" />
                            <h2 class="name"></h2>
                            <p class="description"></p>
                        </div>
                        <div class="ability card">
                            <img class="image" alt="" />
                            <h2 class="name"></h2>
                            <p class="description"></p>
                        </div>
                        <div class="ability card">
                            <img class="image" alt="" />
                            <h2 class="name"></h2>
                            <p class="description"></p>
                        </div>
                    </div>
                </div>
                <a href="#" class="randomize" aria-label="Randomize Warframe">Randomize Warframe</a>
            </div>
            <div class="weapons">
                <div class="primary skeleton">
                    <img class="image" alt="" />
                    <div class="info">
                        <div class="details card">
                            <h2 class="name"></h2>
                            <p class="description"></p>
                            <div class="variants">
                                <div class="variant card">
                                    <img class="image" alt="" />
                                </div>
                                <div class="variant">
                                    <img class="image" alt="" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="randomize" aria-label="Randomize Primary">Randomize Primary</a>
                </div>
                <div class="secondary skeleton">
                    <img class="image" alt="" />
                    <div class="info">
                        <div class="details card">
                            <h2 class="name"></h2>
                            <p class="description"></p>
                            <div class="variants">
                                <div class="variation">
                                    <img class="image" alt="" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="randomize">Randomize Secondary</a>
                </div>
                <div class="melee skeleton">
                    <img class="image" alt="" />
                    <div class="info">
                        <div class="details card">
                            <h2 class="name"></h2>
                            <p class="description"></p>
                            <div class="variants">
                                <div class="variation">
                                    <img class="image" alt="" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="#" class="randomize" aria-label="Randomize Melee">Randomize Melee</a>
                </div>
            </div>
        </div>
        <script src="script.js"></script>

        <script src="https://pluto-lang.org/wasm-builds/out/libpluto/0.9.5/libpluto.js"></script>
        <script src="https://pluto-lang.org/PlutoScript/plutoscript.js"></script>
        <script>
            function get_uploaded() {
                return new Promise((resolve, reject) => {
                    if (document.querySelector("#settings-import-input").files.length) {
                        document
                            .querySelector("#settings-import-input")
                            .files[0].arrayBuffer()
                            .then((ab) => {
                                pluto_give_file("lastData.dat", new Uint8Array(ab))
                                resolve(true)
                            })
                    } else {
                        resolve(false)
                    }
                })
            }
            function onInventoryUploaded(inventory) {
                inventory = JSON.parse(inventory)

                // Get weapons
                const primaryWeapons = inventory.LongGuns.map((weapon) => weapon.ItemType)
                const secondaryWeapons = inventory.Pistols.map((weapon) => weapon.ItemType)
                const meleeWeapons = inventory.Melee.map((weapon) => weapon.ItemType)
                const weapons = [...primaryWeapons, ...secondaryWeapons, ...meleeWeapons]

                // Get warframes
                const warframes = inventory.Suits.map((suit) => suit.ItemType)
                
                // Hide everything first
                weaponData.forEach((weapon) => weapon.hidden = true)
                warframeData.forEach((warframe) => warframe.hidden = true)

                // Unhide the weapons and warframes that are in the inventory
                weapons.forEach((uniqueName) => {
                    const weapon = weaponData.find((w) => w.uniqueName === uniqueName || (w.variants && w.variants.some(v => v.uniqueName === uniqueName)))
                    if (weapon) {
                        weapon.hidden = false
                        console.log(`Unhiding weapon: ${weapon.name} (${weapon.uniqueName})`)
                    }
                })
                // Unhide the warframes that are in the inventory
                console.log(warframeData)
                warframes.forEach((uniqueName) => {
                    const warframe = warframeData.find((w) => w.uniqueName === uniqueName || w.primeUniqueName === uniqueName || w.umbraUniqueName === uniqueName)
                    if (warframe) {
                        warframe.hidden = false
                        console.log(`Unhiding warframe: ${warframe.name} (${warframe.uniqueName})`)
                    }else {
                        console.warn(`Warframe not found: ${uniqueName}`)
                    }
                })

                populateItemList("warframe", warframeData, "#warframe-search")
                populateItemList("primary", getWeaponsFromCategory("primary"), "#primary-search")
                populateItemList("secondary", getWeaponsFromCategory("secondary"), "#secondary-search")
                populateItemList("melee", getWeaponsFromCategory("melee"), "#melee-search")
            }
        </script>
        <script type="pluto">
            local { crypto, json } = require "*"
            document.querySelector("#settings-import-input"):addEventListener("change", function()
                if js_invoke("get_uploaded") then
                    local key <const> = "LEO-ALEC\tEO-ALEC"
                    local iv <const> = "\49\50\70\71\66\51\54\45\76\69\51\45\113\61\57\0"
                    local data = io.contents("lastData.dat")
                                |> crypto.decrypt|"aes-cbc-pkcs7", key, iv|
                                |> json.decode|json.withnull + json.withorder|
                    if data.InventoryJson then
                        data = json.decode(data.InventoryJson, json.withnull + json.withorder)
                    end
                    js_invoke("onInventoryUploaded", json.encode(data))
                end
            end)
        </script>
    </body>
</html>
